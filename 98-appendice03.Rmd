
# Annexo 2

-   simulate species occurences
-   model species distribution
-   species richness and diversity of simulated species

```{r packages-needed, echo=TRUE, eval=FALSE}
library(plyr)
library(tidyverse)
library(terra)
library(geodata)
library(sf)
library(readxl)
library(tmap)
# library(coenocliner) #NO
library(virtualspecies)
```

Simulate across two gradients using coenocliner: 
https://fromthebottomoftheheap.net/2014/07/31/simulating-species-abundance-data-with-the-coenocliner-package/ 
Coenoclines are, according to the Oxford Dictionary of Ecology (Allaby, 1998), “gradients of communities (e.g. in a transect from the summit to the base of a hill), reflecting the changing importance, frequency, or other appropriate measure of different species populations”.

Load data (made in 98-appendice02.Rmd).
```{r load-data}
# Sample points with environmental gradient values
sf_points <- sf::st_read("data/vector/sample_points.shp")
# Study area
newarea <- rast("data/raster/dist_area.tif")
```

Virtual species. Response functions to variables.
```{r test-arirhana}
names(newarea)

# Use the following to test
# giant otter
formatFunctions(human_dist_m = c(fun = 'logisticFun', 
                                 beta = 10000, alpha = -5000),
                x = newarea[["human_dist_m"]])
formatFunctions(water_dist_m = c(fun = 'logisticFun', 
                                 beta = 1000, alpha = 50),
                x = newarea[["water_dist_m"]])
formatFunctions(height = c(fun = 'logisticFun', 
                                 beta = 15, alpha = -5),
                x = newarea[["height"]])
#
para.ptbr <- formatFunctions(
  water_dist_m = c(fun = 'logisticFun', beta = 500, alpha = 50), 
  human_dist_m = c(fun = 'logisticFun', beta = 10000, alpha = -5000), 
  height = c(fun = 'logisticFun', beta = 15, alpha = -5)
                   )

ptbr <- generateSpFromFun(
  raster.stack = newarea[[c("water_dist_m", "human_dist_m", "height")]],
  parameters = para.ptbr, 
  plot = TRUE)

# Run the conversion to presence-absence
# can check distribution with the following
x <- seq(0, 1, length = 100)
y1 <- logisticFun(x, alpha = -0.07, beta = 0.5)
plot(y1 ~ x, type = "l", main = expression(symbol("a = -0.07")),
     xlab = "Environmental suitability", ylab = "Probability of occurrence", cex.axis = 0.8, las = 1, bty = "l")

pa.ptbr <- convertToPA(ptbr, 
                       PA.method = "probability",
                   prob.method = "logistic",
                   beta = 0.50, alpha = -0.07,
                   plot = TRUE)
plot(pa.ptbr$pa.raster)
plotResponse(pa.ptbr)
sppA <- pa.ptbr$pa.raster
names(sppA) <- "sppA"
```

Now lontra.
```{r test-lontra}
names(newarea)

# Use the following to test
formatFunctions(human_dist_m = c(fun = 'logisticFun', 
                                 beta = 1000, alpha = -500),
                x = newarea[["human_dist_m"]])
#
para.lolo <- formatFunctions(
  water_dist_m = c(fun = 'logisticFun', beta = 1000, alpha = 50), 
  human_dist_m = c(fun = 'logisticFun', beta = 1000, alpha = -500)
)

lolo <- generateSpFromFun(
  raster.stack = newarea[[c("water_dist_m", "human_dist_m")]],
  parameters = para.lolo, 
  plot = TRUE)

# Run the conversion to presence-absence
# can check distribution with the following
x <- seq(0, 1, length = 100)
y1 <- logisticFun(x, alpha = -0.07, beta = 0.5)
plot(y1 ~ x, type = "l", main = expression(symbol("a = -0.07")),
     xlab = "Environmental suitability", ylab = "Probability of occurrence", cex.axis = 0.8, las = 1, bty = "l")

pa.lolo <- convertToPA(lolo, 
                       PA.method = "probability",
                   prob.method = "logistic",
                   beta = 0.40, alpha = -0.07,
                   plot = TRUE)
plot(pa.lolo$pa.raster)
plotResponse(pa.lolo)
sppB <- pa.lolo$pa.raster
names(sppB) <- "sppB"
```

Crab eating fox.
```{r fox}

formatFunctions(resident_dist_m = c(fun = 'logisticFun', 
                                 beta = 1000, alpha = -2000),
                x = newarea[["resident_dist_m"]])
formatFunctions(height = c(fun = 'logisticFun', 
                                 beta = 15, alpha = 5),
                x = newarea[["height"]])
formatFunctions(water_dist_m = c(fun = 'logisticFun', 
                                 beta = 50, alpha = -50),
                x = newarea[["water_dist_m"]])
#
para.ceth <- formatFunctions(
  water_dist_m = c(fun = 'logisticFun', beta = 50, alpha = -50), 
  resident_dist_m = c(fun = 'logisticFun', beta = 1000, alpha = -2000), 
  height = c(fun = 'logisticFun', beta = 15, alpha = 5) 
)

ceth <- generateSpFromFun(
  raster.stack = newarea[[c("resident_dist_m", "height", "water_dist_m")]],
  parameters = para.ceth, 
  plot = TRUE)

pa.ceth <- convertToPA(ceth, 
                       PA.method = "probability",
                   prob.method = "logistic",
                   beta = 0.40, alpha = -0.07,
                   plot = TRUE)
sppC <- pa.ceth$pa.raster
names(sppC) <- "sppC"
```

Ocelot.
```{r fox}

formatFunctions(resident_dist_m = c(fun = 'logisticFun', 
                                 beta = 3000, alpha = -2000),
                x = newarea[["resident_dist_m"]])
formatFunctions(biomass = c(fun = 'logisticFun', 
                                 beta = 15, alpha = -50),
                x = newarea[["biomass"]])
formatFunctions(water_dist_m = c(fun = 'logisticFun', 
                                 beta = 50, alpha = -50),
                x = newarea[["water_dist_m"]])
#
para.lepa <- formatFunctions(
  water_dist_m = c(fun = 'logisticFun', beta = 50, alpha = -50), 
  resident_dist_m = c(fun = 'logisticFun', beta = 3000, alpha = -2000), 
  biomass = c(fun = 'logisticFun', beta = 15, alpha = -50) 
)

lepa <- generateSpFromFun(
  raster.stack = newarea[[c("resident_dist_m", "biomass", "water_dist_m")]],
  parameters = para.lepa, 
  plot = TRUE)

pa.lepa <- convertToPA(lepa, 
                       PA.method = "probability",
                   prob.method = "logistic",
                   beta = 0.50, alpha = -0.07,
                   plot = TRUE)
sppD <- pa.lepa$pa.raster
names(sppD) <- "sppD"
```

Puma.
```{r puma}

# puma
formatFunctions(risk_dist_m = c(fun = 'logisticFun', 
                                 beta = 10000, alpha = -500),
                x = newarea[["risk_dist_m"]])
formatFunctions(resident_dist_m = c(fun = 'logisticFun', 
                                 beta = 5000, alpha = -5000),
                x = newarea[["resident_dist_m"]])
formatFunctions(biomass = c(fun = 'logisticFun', 
                                 beta = 15, alpha = -50),
                x = newarea[["biomass"]])
#
para.puco <- formatFunctions(
  risk_dist_m = c(fun = 'logisticFun', beta = 10000, alpha = -500), 
  resident_dist_m = c(fun = 'logisticFun', beta = 5000, alpha = -5000), 
  biomass = c(fun = 'logisticFun', beta = 15, alpha = -50)
                   )
puco <- generateSpFromFun(
  raster.stack = newarea[[c("resident_dist_m", "biomass", "risk_dist_m")]],
  parameters = para.puco, 
  species.type = "additive",
  plot = TRUE)

pa.puco <- convertToPA(puco, 
                       PA.method = "probability",
                   prob.method = "logistic",
                   beta = 0.40, alpha = -0.07,
                   plot = TRUE)
sppE <- pa.puco$pa.raster
names(sppE) <- "sppE"

```

Primates. 
Ateles.
```{r ateles}

formatFunctions(human_dist_m = c(fun = 'logisticFun', 
                                 beta = 10000, alpha = -5000),
                x = newarea[["human_dist_m"]])
formatFunctions(biomass= c(fun = 'logisticFun', 
                                 beta = 200, alpha = -50),
                x = newarea[["biomass"]])
formatFunctions(height = c(fun = 'logisticFun', 
                                 beta = 20, alpha = -5),
                x = newarea[["height"]])
formatFunctions(floresta = c(fun = 'logisticFun', 
                                 beta = 1, alpha = -1),
                x = newarea[["floresta"]])
#
para.at <- formatFunctions(
  human_dist_m = c(fun = 'logisticFun', beta = 10000, alpha = -5000), 
  height = c(fun = 'logisticFun', beta = 25, alpha = -5), 
    biomass = c(fun = 'logisticFun', beta = 250, alpha = -50), 
  floresta = c(fun = 'logisticFun', beta = 1, alpha=-1)
                   )

at <- generateSpFromFun(
  raster.stack = newarea[[c("human_dist_m", "height", "biomass", 
                            "floresta")]],
  parameters = para.at, 
  species.type = "additive",
  plot = TRUE)

pa.at <- convertToPA(at, 
                       PA.method = "probability",
                   prob.method = "logistic",
                   beta = 0.50, alpha = -0.07,
                   plot = TRUE)
sppF <- pa.at$pa.raster
names(sppF) <- "sppF"

```

Capuchin.
```{r cebus}
formatFunctions(human_dist_m = c(fun = 'logisticFun', 
                                 beta = 10000, alpha = -5000),
                x = newarea[["human_dist_m"]])
formatFunctions(biomass= c(fun = 'logisticFun', 
                                 beta = 200, alpha = -50),
                x = newarea[["biomass"]])
formatFunctions(height = c(fun = 'logisticFun', 
                                 beta = 20, alpha = -5),
                x = newarea[["height"]])
formatFunctions(forest = c(fun = 'logisticFun', 
                                 beta = 0.5, alpha = -0.5),
                x = newarea[["forest"]])
#
para.ceap <- formatFunctions(
  human_dist_m = c(fun = 'logisticFun', beta = 1000, alpha = -500), 
  height = c(fun = 'logisticFun', beta = 15, alpha = -5), 
    biomass = c(fun = 'logisticFun', beta = 50, alpha = -50), 
  forest = c(fun = 'logisticFun', beta = 0.5, alpha=-0.5)
                   )

ceap <- generateSpFromFun(
  raster.stack = newarea[[c("human_dist_m", "height", "biomass", 
                            "forest")]],
  parameters = para.ceap, 
  species.type = "additive",
  plot = TRUE)

pa.ceap <- convertToPA(ceap, 
                       PA.method = "probability",
                   prob.method = "logistic",
                   beta = 0.50, alpha = -0.07,
                   plot = TRUE)
sppG <- pa.ceap$pa.raster
names(sppG) <- "sppG"
plotResponse(pa.ceap)

```

Try with PCA.
```{rtry-pca}
set.seed(1234)
random.spp01 <- generateRandomSp(raster.stack = newarea, 
                               approach = "pca", 
                               sample.points = TRUE, 
                                        nb.points = 5000)
random.spp02 <- generateRandomSp(raster.stack = newarea, 
                               approach = "pca", 
                               niche.breadth = "wide", 
                               species.prevalence = 0.5)
random.spp03 <- generateRandomSp(raster.stack = newarea, 
                               approach = "pca", 
                               niche.breadth = "wide", 
                               beta = 0.531005859375, 
                               alpha = 0.1)
random.spp04 <- generateRandomSp(raster.stack = newarea, 
                               approach = "pca", 
                               niche.breadth = "wide", 
                               beta = 0.431005859375, 
                               alpha = -0.05)
random.pca.species <- generateSpFromPCA(raster.stack = newarea, 
                                        sample.points = TRUE, 
                                        nb.points = 5000)
narrow.species <- generateSpFromPCA(raster.stack = newarea,
                                    sample.points = TRUE,
                                    nb.points = 5000,
                                    niche.breadth = "narrow")
wide.species <- generateSpFromPCA(raster.stack = newarea,
                                    sample.points = TRUE,
                                    nb.points = 5000,
                                    niche.breadth = "wide")
pa.random <- convertToPA(random.pca.species, 
                       PA.method = "probability",
                   prob.method = "logistic",
                   beta = 0.50, alpha = -0.07,
                   plot = TRUE)
pa.wide <- convertToPA(wide.species, 
                       PA.method = "probability",
                   prob.method = "logistic",
                   beta = 0.50, alpha = -0.07,
                   plot = TRUE)
pa.narrow <- convertToPA(narrow.species, 
                       PA.method = "probability",
                   prob.method = "logistic",
                   beta = 0.20, alpha = -0.07,
                   plot = TRUE)
# random
sppH <- pa.random$pa.raster
names(sppH) <- "sppH"
#wide
sppI <- pa.wide$pa.raster
names(sppI) <- "sppI"
#narrow
sppJ <- pa.narrow$pa.raster
names(sppJ) <- "sppJ"

sppK <- random.spp01$pa.raster
sppL <- random.spp02$pa.raster
sppM <- random.spp03$pa.raster
sppN <- random.spp04$pa.raster
names(sppK) <- "sppK"
names(sppL) <- "sppL"
names(sppM) <- "sppM"
names(sppN) <- "sppN"
```


Final presence for export.
```{r export-presence}
# carnivores
carnivores <- c(sppA, sppB, sppC, sppD, sppE)
# Primates
primates <- c(sppF, sppG)
# PCA
pca_sp <- c(sppH, sppI, sppJ, sppK, sppL, sppM, sppN)
species <- c(carnivores, primates, pca_sp)
```

Export.
```{r export-species}
#export
writeRaster(species, "data/raster/species_area.tif", 
              gdal=c("COMPRESS=DEFLATE"), overwrite = TRUE)
```

Sample species by points - extract buffer 5 km - ? how many points?
If enough sample 10 at random and use as abundances.?
Use function!!! Species by species - make fuunction to do this.
```{r species-sample-points}
PA.points.sppA <- sampleOccurrences(pa.ptbr,
                               n = 1200,
                               type = "presence-absence", 
                               detection.probability = 0.8)
PA.points.sppB <- sampleOccurrences(pa.lolo,
                               n = 1200,
                               type = "presence-absence", 
                               detection.probability = 0.6)
PA.points.sppC <- sampleOccurrences(pa.ceth,
                               n = 1200,
                               type = "presence-absence", 
                               detection.probability = 0.7)
PA.points.sppD <- sampleOccurrences(pa.lepa,
                               n = 1200,
                               type = "presence-absence", 
                               detection.probability = 0.6)
PA.points.sppE <- sampleOccurrences(pa.paon,
                               n = 1200,
                               type = "presence-absence", 
                               detection.probability = 0.5)
PA.points.sppF <- sampleOccurrences(pa.at,
                               n = 1200,
                               type = "presence-absence", 
                               detection.probability = 0.7)
PA.points.sppG <- sampleOccurrences(pa.ceap,
                               n = 1200,
                               type = "presence-absence", 
                               detection.probability = 0.9)
PA.points.sppH <- sampleOccurrences(pa.wide,
                               n = 1200,
                               type = "presence-absence", 
                               detection.probability = 0.8)
PA.points.sppI <- sampleOccurrences(pa.wide,
                               n = 1200,
                               type = "presence-absence", 
                               detection.probability = 0.7)
PA.points.sppJ <- sampleOccurrences(pa.wide,
                               n = 1200,
                               type = "presence-absence", 
                               detection.probability = 0.5)
PA.points.sppK <- sampleOccurrences(random.spp01,
                               n = 1200,
                               type = "presence-absence", 
                               detection.probability = 0.8)
PA.points.sppL <- sampleOccurrences(random.spp02,
                               n = 1200,
                               type = "presence-absence", 
                               detection.probability = 0.8)
PA.points.sppM <- sampleOccurrences(random.spp03,
                               n = 1200,
                               type = "presence-absence", 
                               detection.probability = 0.8)
PA.points.sppN <- sampleOccurrences(random.spp04,
                               n = 1200,
                               type = "presence-absence", 
                               detection.probability = 0.8)

```

Bind together.
```{r bind-species-points}
bind_rows( 
  PA.points.sppA$sample.points |> mutate(sp = "sppA"), 
  PA.points.sppB$sample.points |> mutate(sp = "sppB"), 
  PA.points.sppC$sample.points |> mutate(sp = "sppC"), 
  PA.points.sppD$sample.points |> mutate(sp = "sppD"), 
  PA.points.sppE$sample.points |> mutate(sp = "sppE"), 
  PA.points.sppF$sample.points |> mutate(sp = "sppF"), 
  PA.points.sppG$sample.points |> mutate(sp = "sppG"), 
  #dont use as all have very similar pattern
  #PA.points.sppH$sample.points |> mutate(sp = "sppH"), 
  #PA.points.sppI$sample.points |> mutate(sp = "sppI"), 
  #PA.points.sppJ$sample.points |> mutate(sp = "sppJ"), 
  PA.points.sppK$sample.points |> mutate(sp = "sppH"), 
  PA.points.sppL$sample.points |> mutate(sp = "sppI"), 
  PA.points.sppM$sample.points |> mutate(sp = "sppJ"),
  PA.points.sppN$sample.points |> mutate(sp = "sppK")
  ) -> species_points

```


Test to see how many across interview samples.
```{r count-interview-samples}
int_5km <- st_buffer(interviews_4326[, "aid"], 5000)
# Function to count species abundances around interviews.
extract_counts <- function(x){
dfin <- x
sample_area <- int_5km
sample_4326 <- st_as_sf(x = dfin,           
               coords = c("x", "y"),
               crs = 4326)
int_sample <- lengths(st_intersects(sample_area, sample_4326))
int_presence <- lengths(st_intersects(sample_area, sample_4326 |> 
                                        filter(Observed==1)))
sample_area$int_pres <- lengths(st_intersects(sample_area, sample_4326 |> 
                                        filter(Observed==1)))
sample_area |> 
  data.frame() |> 
  select(aid, int_pres) -> dfout
dfout
}

species_counts <- plyr::ddply(species_points, .(sp), 
                              .fun = extract_counts)
#join interview and counts
interviews |> 
  select(aid, Latitude, Longitude, Habitat_WWF) |>
  left_join(species_counts) -> interview_counts

```

Export results
```{r export-species-counts}

write.csv(interview_counts, "data/interview_counts.csv", 
          row.names = FALSE)
```

